<!DOCTYPE html>
<html>
<body>

<script>
var query = window.location.search.substring(1);
var vars = query.split("&");
var q={};
for (var i=0;i<vars.length;i++) {
	var pair = vars[i].split("=");
	q[pair[0]] = pair[1];
}
var size = 20;
console.log(query);
console.log(JSON.stringify(q));
var count = 0;
var start = parseInt(q.start || 1);
var galleryLength = parseInt(q.updates)
console.log(start);
var t0 = performance.now();
function run(){
	for(i = start; i < (galleryLength + start); i++) {
		runRequest(i, size);
	}
}
function runRequest(pos,size){
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.position = pos;
	xmlhttp.size = size;
	var url = "http://localhost/images_load/exist_multi_info.php?g="+pos+"&n="+q.src+'&s='+q.server+'&z='+size;
	xmlhttp.onreadystatechange = function(e) {
		if (e.target.readyState == 4 && e.target.status == 200) {
			//get response array
			var value = JSON.parse(e.target.responseText);
			//console.log(value, e.target.position);
			var last = value.data[value.data.length-1];
			
			//console.log(last);
			//has more items -> increase size and reload
			if(last.pass || (last.error && last.error_code == 28)){
				//console.log('large: '+e.target.size);
				runRequest(e.target.position,e.target.size+20);
			}else if(last.error && last.error_code == 302){
				var lastPosition = value.data.length;
				if(value.data[0].error_code == 302){
					lastPosition = 0;
				}else{
					while((item=value.data.pop()) != null){
						if(item.error_code == 302 && lastPosition > item.i){
							lastPosition = item.i;
						}
					}
				}
				window.parent.postMessage(JSON.stringify({type:'progress',data:{position:e.target.position, limit:lastPosition, src:q.src, server:q.server}}),"*");
				console.log(e.target.position, lastPosition);
				checkIfLast();
			}else{
				checkIfLast();
				console.log('other error', last.pass);
			}
		}
	};
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
}
function checkIfLast(){
	count++;
	if(count >= galleryLength){
		window.parent.postMessage(JSON.stringify({type:'loaded',data:{total:galleryLength, src:q.src}}),"*");
		var t1 = performance.now();
		console.log("Call to doSomething took " + (t1 - t0) + " milliseconds.")
	}
	console.log('position',count+" - "+galleryLength);
}
run();
</script>

</body>
</html>
